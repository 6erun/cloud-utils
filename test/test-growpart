#!/bin/sh

set -e

MP=""
LODEV=""

cleanup() {
	[ -z "$MP" ] || { echo "unmount $MP"; umount "$MP"; }
	[ -z "$LODEV" ] || { echo "losetup -d $LODEV"; losetup -d "$LODEV"; }
}
rq() {
	"$@" > /tmp/out 2>&1 ||
		{ echo "FAILED:" "$@"; cat /tmp/out; return 1; }
}
trap cleanup EXIT

img=/tmp/my.img
mp=/tmp/mp

size=1000M
osize=500M
rm -f $img
[ ! -e $mp ] || rmdir $mp || { echo "failed rmdir $mp"; exit 1; }
mkdir $mp

truncate --size $osize "$img"

rq sgdisk --new 1:2048: "$img"

truncate --size "$size" "$img"

lodev=$(losetup --show --find "$img")
lodevpart="${lodev}p1"
LODEV=$lodev
echo "set up $lodev"

#udevadm settle
#bash

rq mkfs.ext4 "${lodevpart}"

echo "mounting to $mp"
mount "${lodevpart}" "$mp"
MP="$mp"

echo "==== before ===="
grep "${lodev##*/}" /proc/partitions

growpart -v -v "$lodev" 1

echo "==== after ===="
grep "${lodev##*/}" /proc/partitions

resize2fs "${lodevpart}"

echo == df ==
df -h "$mp"
